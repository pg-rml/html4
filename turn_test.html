<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>흐트므르IV</title>
<script type="text/javascript">

    // 김철수 씨
    var partner = new Image();
    //partner.src = "./image/partner_standing/kim_neutral.png";

    var partner_neutral = new Image();
    partner_neutral.src = "./image/partner_standing/kim_neutral.png";

    var partner_bad = new Image();
    partner_bad.src = "./image/partner_standing/kim_bad.png";

    var partner_happy = new Image();
    partner_happy.src = "./image/partner_standing/kim_happy.png";


    // 맨 뒷배경 
    var black = new Image();
    black.src = "./image/stage_bg/black.png";

    // 가운데 투명화 된 배경 
    var background = new Image();
    background.src = "./image/stage_bg/stage1.png";

    // 버튼 (주인공) 눌렸을 때 / 평소
    var button_on = new Image();
    button_on.src = "./image/button/button_on.png";

    var button_off = new Image();
    button_off.src = "./image/button/button_off.png";

    // 모스부호 점 / 선
    var dot = new Image();
    dot.src = "./image/dot.png";

    var line = new Image();
    line.src = "./image/line.png";

    // 판정 선 확인용 (이제 안 씀)
    var judgeline = new Image();
    judgeline.src = "./image/judgeline.png";

    // 판정 라이트 틀림 / 맞음
    var red = new Image();
    red.src = "./image/red.png";

    var green = new Image();
    green.src = "./image/green.png";

    // 안씀
    var white = new Image();
    white.src = "./image/white.png";

    // 누른 키 종류 판별하는 함수 
    var keycode;
    // 눌렀는지 판별 
    var push = 0; 

    // 키다운 상태일 때 판정되지 않게 하려고 timeout을 이용함
    // 해당 timeout이 중복으로 실행되지 않도록 검사하는 변수 
    var keyid = null;
    // 뭐임이거 안쓰는듯
    var keyevent = 0;

    // 플레이어 턴인지 파트너 턴인지 
    // 1인 쪽이 활성화된 턴 
    var playerTurn = 0;
    var partnerTurn = 1;

    // 임시 말풍선 (깃허브에 이미지 푸시되어있지 않음)
    var textBalloon = new Image();
    textBalloon.src = "./image/TB_test.png";

    // 주인공 대사 
    var stage1 = [
        [0, 0, 0, 0, 0, 0],
        [1, 1, 1, 1, 0, 1],
        [1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0],
        [1, 0, 1, 1, 0, 0, 0, 0],
        [1, 1, 1, 1, 0, 1],
        [0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0],
        [1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1],
        [1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1],
        [1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0],
        [0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0]
        ];

    //stage1[0][0] = [0, 0, 0, 1, 1, 1, 0, 0, 0];
    
    // 몇번째 대사인지 
    var step = -1;
    // 몇번째 모스부호인지 
    var index = 0; 

    // 판정 표시용 변수 (맞았는지 틀렸는지)
    var judgelight = -1; 

    // 화면에 표시되는 모스부호 저장용 배열 
    var onScreen = [];
    var heart = 1000; // 기본 체력
    var gameRunning = true; // 게임이 돌아가고 있는지

    //setInterval 키 얻기용
    var runGameKey;
    // 중복 실행 방지용 키
    var printMorseKey = null;
    var timeoutKey = null;

    // 클리어 화면 출력용 변수 
    var clear = 0;


    // 모스부호 객체 (타입/이미지 저장용)
    class Morse {
        constructor(type){
            this.type = type;
            this.image = new Image();
            this.x = 1000;

            if(type == 0) this.image.src = "./image/dot.png";
            else if(type == 1) this.image.src = "./image/line.png";
        }
    }
    // 페이지 시작 시 발동되는 함수
    function loaded(){

        // 태그 가져옴
        canvas = document.getElementById('c1');
        context = canvas.getContext('2d');

        //runGame();

        // 무한하게 runGame을 돌릴것임
        runGameKey = setInterval(runGame, 10);
        //printMorseKey = setInterval(printMorse, 1000);
    }

    // 무한히 모든 것을 그림
    function runGame() {

        if(clear == 1){

            partner.src = partner_happy.src;
            context.drawImage(partner, 350, 22, 560, 350);
            context.font = "60px Arial";
            context.fillStyle = "green";
            context.fillText("CLEAR", 440, 360);
            gameRunning = false;
        
        }
        // 플레이어 턴인지 상대 턴인지 확인
        if(gameRunning){
                if (partnerTurn == 1) {
                console.log("partner");
                runPartner();
            }
            else if (playerTurn == 1) {
                console.log("player");
                runPlayer();
            //if(printMorseKey == null) printMorseKey = setInterval(printMorse, 500);
            }
        }
        
    }

    // 화면에 출력될 모스부호를 가져옴 
    function printMorse() {
        if(index < stage1[step].length){
            onScreen.push(new Morse(stage1[step][index]));
            index = index + 1;
        }
    }

    // 그림
    function runPartner(){

        partner.src = partner_neutral.src;

        // 요소 출력 
        context.clearRect(0, 0, canvas.width, canvas.height); // 초기화
        context.drawImage(black, 0, 0, 1280, 720);

        context.drawImage(background, 0, 0, 1280, 720);
        context.drawImage(partner, 350, 22, 560, 350);

        context.drawImage(textBalloon, 300, 22, 300, 300);
        
        context.drawImage(button_off, 430, 450, 400, 300);

        // printMorse가 실행되고 있을 경우, 중지시킴 
        if(printMorseKey != null) clearInterval(printMorseKey);

        // 1.5초 뒤에 턴 전환
        // 183번 줄 1500 수정하면 턴 전환 타이밍 바꿀 수 있음
        // 182번 줄 500 수정하면 모스부호 간격 바꿀 수 있음
        if(timeoutKey == null) {
            timeoutKey = setTimeout(()=>{
                partnerTurn = 0; 
                playerTurn = 1; 
                step = step + 1; 
                index = 0;
                judgelight = -1;
                printMorseKey = setInterval(printMorse, 500);
            }, 1500);
        }



    }

    // 플레이어 턴 
    function runPlayer(){

        context.clearRect(0, 0, canvas.width, canvas.height); // 초기화
        context.drawImage(black, 0, 0, 1280, 720);
        
        // 모스부호 출력 
        for(let i = 0; i < onScreen.length; i++){
            context.drawImage(onScreen[i].image, onScreen[i].x, 400, 100, 100);
            onScreen[i].x = onScreen[i].x - 6; // 여기 6 수정하면 모스부호 오는 속도 바꿀 수 있음 
        }
        
        context.drawImage(background, 0, 0, 1280, 720);
        context.drawImage(partner, 350, 22, 560, 350);

        // 버튼 변환 
        if(push == 0) context.drawImage(button_off, 430, 450, 400, 300);
        else if(push == 1) context.drawImage(button_on, 430, 450, 400, 300);

        // 못 치고 넘어갔을 경우 판정. 140 숫자 줄이면 판정 널널해짐. 
        if(onScreen.length != 0 && onScreen[0].x < 140) {
            trash = onScreen.shift();
            judgelight = 0; 
            heart--; // 체력 감소
            partner.src = partner_bad.src;

            if(onScreen.length == 0){

                if(step == 9){
                    playerTurn = 0;
                    clear = 1;
                }
                else{
                    playerTurn = 0;
                    partnerTurn = 1;
                    timeoutKey = null;
                }
            }

            

            if (heart <= 0) {
                heart = 0;
                gameRunning = false; // 게임 정지
            }
            
        }
        

        if(judgelight == 0) context.drawImage(red, 270, 300, 50, 30);
        else if(judgelight == 1) context.drawImage(green, 270, 300, 50, 30);
        
        //context.drawImage(judgeline, 290, 400, 10, 100);

        // 체력 표시
        context.font = "30px Arial";
        context.fillStyle = "black";
        context.fillText("Heart: " + heart, 1100, 60);

        // 게임 오버 표시
        if (!gameRunning) {
            context.drawImage(partner, 350, 22, 560, 350);
            context.font = "60px Arial";
            context.fillStyle = "red";
            context.fillText("GAME OVER", 440, 360);
        }

    }

    function keydown(){
        // 눌러진 key의 코드값
        keycode = event.keyCode;

        // 32가 스페이스바라는 뜻. 나중에 점이랑 선 구분용도로 수정해야 함. 
        if(keycode == 32){
            if(keyid == null) {
                // 260보다 늘리고 140보다 줄이면 판정 널널해짐. 위쪽에 140이랑 여기랑 숫자 맞춰야 함. 
                if(onScreen.length != 0 && onScreen[0].x <= 260 && onScreen[0].x >=140){
                    trash = onScreen.shift();
                    partner.src = partner_happy.src;
                    //console.log(onScreen.length);
                    judgelight = 1;
                    if(onScreen.length == 0){
                        if(step == 9){
                            playerTurn = 0;
                            clear = 1;
                        }

                        else{
                            playerTurn = 0;
                            partnerTurn = 1;
                            timeoutKey = null;
                        }
                    }
                }
                keyid = setTimeout(function(){push = 0;}, 100);
                push = 1;
            }
            return;
        }
    }

    function keyup(){
        keycode = event.keyCode;
        switch(keycode){
            case 32: 
                clearTimeout(keyid);
                keyid = null;
                push = 0; 
                break;
        }
    }

</script>
</head>
<body onload="loaded()" onkeydown="keydown()" onkeyup="keyup()">
    <canvas width="1280" height="720" style="border: 2px solid black;" id="c1"></canvas>
</body>
</html>
